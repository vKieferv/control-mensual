<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gastos D煤o (Test)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-view { display: none !important; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* SEMFORO ESTADOS (Tu L贸gica) */
        .card-red { background: white; border-left: 6px solid #ef4444; }      /* Nada */
        .card-blue { background: #eff6ff; border-left: 6px solid #3b82f6; }    /* Azul: Falta Reembolso (Espera) */
        .card-yellow { background: #fffbeb; border-left: 6px solid #f59e0b; }  /* Amarillo: Falta Pagar Cta (Alerta) */
        .card-green { background: #f0fdf4; border-left: 6px solid #22c55e; opacity: 0.7; } /* Verde: Listo */

        /* Badges */
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .badge-green { background: #dcfce7; color: #166534; }

        /* Botones Check */
        .check-btn { transition: all 0.2s; cursor: pointer; }
        .check-btn:active { transform: scale(0.95); }
        .check-active { background-color: #22c55e; border-color: #22c55e; color: white; }
        .check-inactive { background-color: white; border-color: #cbd5e1; color: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <!-- LOGIN (OCULTO) -->
    <div id="view-login" class="hidden flex-col items-center justify-center min-h-screen p-6"></div>

    <!-- APP PRINCIPAL -->
    <div id="view-app" class="pb-32 fade-in">
        
        <!-- Navbar -->
        <nav class="bg-white sticky top-0 z-30 px-5 py-4 shadow-sm border-b border-slate-100 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold border-2 border-indigo-200">
                    V
                </div>
                <div class="leading-tight">
                    <p class="text-[10px] uppercase font-bold text-green-500 flex items-center gap-1">
                        <i class="fas fa-wifi"></i> Online
                    </p>
                    <p id="userName" class="font-bold text-slate-800 text-sm">Vicente</p>
                </div>
            </div>
            <div class="bg-slate-100 rounded-lg px-2 py-1">
                <input type="month" id="monthSelector" class="bg-transparent text-xs font-bold text-slate-600 outline-none cursor-pointer" onchange="changeMonth()">
            </div>
        </nav>

        <main class="p-5 max-w-2xl mx-auto space-y-6">

            <!-- 1. RESUMEN DEUDA -->
            <div id="debtCard" class="bg-slate-800 p-6 rounded-3xl shadow-lg text-white relative overflow-hidden transition-all">
                <div class="flex justify-between items-start z-10 relative">
                    <div>
                        <p class="text-indigo-300 text-xs font-bold uppercase tracking-widest mb-1">Carlos te debe</p>
                        <h2 class="text-4xl font-extrabold" id="debtAmount">$0</h2>
                    </div>
                    <div class="text-right">
                        <span class="bg-white/10 px-3 py-1 rounded-full text-[10px] font-bold uppercase backdrop-blur-md text-indigo-100">
                            Por cobrar
                        </span>
                    </div>
                </div>
            </div>

            <!-- 2. FORMULARIO CON MEMORIA -->
            <div id="actionPanel" class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 relative z-10">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Nuevo Gasto</p>
                    <span id="loadingDefaults" class="text-[10px] text-blue-500 animate-pulse hidden">Cargando precios...</span>
                </div>
                
                <!-- Botones Din谩micos -->
                <div id="quickButtonsContainer" class="flex gap-2 overflow-x-auto hide-scroll mb-4 pb-1"></div>

                <div class="flex gap-3 mb-3">
                    <input type="text" id="inputName" placeholder="Concepto" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none text-sm focus:bg-white focus:ring-2 focus:ring-indigo-100 transition">
                    <input type="number" id="inputAmount" placeholder="$ Total" class="w-1/3 p-3 bg-slate-50 rounded-xl font-bold text-slate-700 outline-none text-center text-sm focus:bg-white focus:ring-2 focus:ring-indigo-100 transition">
                </div>
                
                <!-- Selector Tipo -->
                <div class="flex gap-2 mb-3 bg-slate-50 p-1 rounded-xl">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="expType" value="house" checked class="peer sr-only">
                        <div class="py-2 text-center text-xs font-bold text-slate-400 rounded-lg peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition">
                             Compartido (50%)
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="expType" value="personal" class="peer sr-only">
                        <div class="py-2 text-center text-xs font-bold text-slate-400 rounded-lg peer-checked:bg-white peer-checked:text-emerald-600 peer-checked:shadow-sm transition">
                             Solo M铆o
                        </div>
                    </label>
                </div>

                <button id="saveBtn" onclick="saveExpense()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-black transition shadow-lg active:scale-95">Guardar</button>
            </div>

            <!-- 3. LISTA DE MOVIMIENTOS -->
            <div id="expensesContainer" class="space-y-4 pb-10"></div>

        </main>
    </div>

    <!-- ALERTA DE ERROR (Visible si falla) -->
    <div id="errorAlert" class="hidden fixed bottom-5 left-5 right-5 bg-red-600 text-white p-4 rounded-2xl shadow-2xl z-50 text-xs font-mono">
        <p class="font-bold mb-1">锔 ERROR DE CONEXIN:</p>
        <span id="errorMsg">...</span>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl text-xs font-bold opacity-0 transition-all pointer-events-none z-50 -translate-y-4 flex items-center gap-2">
        <span id="toastMsg">Mensaje</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, updateDoc, deleteDoc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        // ==========================================
        // 1. TUS CREDENCIALES (隆PEGA AQU!)
        // ==========================================
        const firebaseConfig = {
  apiKey: "AIzaSyALsMoeqqLpQge9hMocUHSjmqnpJXNJ9p4",
  authDomain: "control-mensual-ae833.firebaseapp.com",
  projectId: "control-mensual-ae833",
  storageBucket: "control-mensual-ae833.firebasestorage.app",
  messagingSenderId: "909368343478",
  appId: "1:909368343478:web:0733b7a0a57cec5893df17"
};

        // 2. CONFIGURACIN
        const CONFIG = {
            ADMIN: 'vicente8sanchez@gmail.com',  
            PARTNER: 'carlos.real@gmail.com', 
            TEST_USER: { email: 'vicho.real@gmail.com', name: 'Vicente (Test)', role: 'admin' },
            
            // Servicios Base
            DEFAULT_SERVICES: [
                { name: 'Arriendo', amount: 350000, icon: 'fa-home', color: 'indigo' },
                { name: 'Luz', amount: 45000, icon: 'fa-lightbulb', color: 'yellow' },
                { name: 'Agua', amount: 25000, icon: 'fa-faucet', color: 'blue' },
                { name: 'Gas', amount: 60000, icon: 'fa-fire', color: 'orange' },
                { name: 'GC', amount: 90000, icon: 'fa-building', color: 'slate' },
                { name: 'Internet', amount: 30000, icon: 'fa-wifi', color: 'purple' }
            ]
        };

        // Inicializaci贸n Segura
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch(e) {
            showError("Configuraci贸n de Firebase inv谩lida. Revisa el archivo.");
        }

        let currentUser = CONFIG.TEST_USER;
        let selectedMonth = new Date().toISOString().slice(0, 7);
        let allData = [];
        let expenseDefaults = {};

        // --- CONEXIN AUTOMTICA (AUTO-LOGIN) ---
        // Esto permite guardar datos sin mostrar el login de Google
        if (auth) {
            signInAnonymously(auth)
                .then(() => {
                    initUI(); // Iniciar solo si conecta
                })
                .catch((error) => {
                    showError("No se pudo conectar a la base de datos: " + error.message);
                });
        }

        async function initUI() {
            document.getElementById('monthSelector').value = selectedMonth;
            
            // Etiquetas
            if(currentUser.email === CONFIG.PARTNER) {
                document.getElementById('debtLabel').textContent = "Le debes a Vicente";
            } else {
                document.getElementById('debtLabel').textContent = "Carlos te debe";
            }
            
            await loadDefaults(); 
            renderQuickButtons();
            listenData();
        }

        // --- BASE DE DATOS ---
        async function loadDefaults() {
            try {
                const docRef = doc(db, "config", "expense_defaults");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) expenseDefaults = docSnap.data();
                else {
                    expenseDefaults = {};
                    CONFIG.DEFAULT_SERVICES.forEach(s => expenseDefaults[s.name] = s.amount);
                }
            } catch (e) { console.log("Usando defaults locales"); }
            renderQuickButtons();
        }

        async function updateDefaultPrice(name, newAmount) {
            const isKnown = CONFIG.DEFAULT_SERVICES.some(s => s.name === name);
            if(isKnown) {
                expenseDefaults[name] = newAmount;
                try { await setDoc(doc(db, "config", "expense_defaults"), expenseDefaults); } catch(e){}
                renderQuickButtons();
            }
        }

        function listenData() {
            const q = query(collection(db, "gastos"), where("month", "==", selectedMonth));
            onSnapshot(q, (snapshot) => {
                allData = [];
                snapshot.forEach(doc => allData.push({ id: doc.id, ...doc.data() }));
                renderList();
            }, (error) => {
                showError("Permiso denegado. Revisa las Reglas de Firestore en la consola.");
            });
        }

        // --- RENDERIZADO ---
        function renderQuickButtons() {
            const container = document.getElementById('quickButtonsContainer');
            container.innerHTML = '';

            CONFIG.DEFAULT_SERVICES.forEach(s => {
                const currentAmount = expenseDefaults[s.name] || s.amount;
                const formatAmt = currentAmount >= 1000 ? `${Math.round(currentAmount/1000)}k` : currentAmount;

                const btn = document.createElement('button');
                let colorClass = `bg-${s.color}-50 text-${s.color}-700 border-${s.color}-100`;
                // Fallback colores simples si tailwind falla dinamicamente
                if(s.color==='indigo') colorClass='bg-indigo-50 text-indigo-700 border-indigo-100';
                if(s.color==='yellow') colorClass='bg-yellow-50 text-yellow-700 border-yellow-100';
                if(s.color==='blue') colorClass='bg-blue-50 text-blue-700 border-blue-100';
                if(s.color==='orange') colorClass='bg-orange-50 text-orange-700 border-orange-100';
                if(s.color==='slate') colorClass='bg-slate-100 text-slate-600 border-slate-200';
                if(s.color==='purple') colorClass='bg-purple-50 text-purple-700 border-purple-100';

                btn.className = `shrink-0 ${colorClass} border px-3 py-2 rounded-xl text-xs font-bold transition active:scale-95 flex flex-col items-center min-w-[70px]`;
                btn.onclick = () => prefill(s.name, currentAmount, true);
                
                btn.innerHTML = `
                    <i class="fas ${s.icon} text-lg mb-1"></i>
                    <span>${s.name}</span>
                    <span class="text-[9px] opacity-70 font-mono">$${formatAmt}</span>
                `;
                container.appendChild(btn);
            });
        }

        function renderList() {
            const container = document.getElementById('expensesContainer');
            container.innerHTML = '';

            let totalDebtToVicho = 0;
            let myView = allData.filter(e => e.type === 'house' || e.userId === currentUser.email);

            // Orden Prioridad: Amarillo > Azul > Rojo > Verde
            myView.sort((a, b) => getStatusScore(a) - getStatusScore(b));

            if(myView.length === 0) {
                container.innerHTML = `<div class="text-center py-10 opacity-50"><p class="text-xs text-slate-400">Sin registros</p></div>`;
                return;
            }

            myView.forEach(item => {
                if (item.type === 'house' && !item.paidReimbursement) totalDebtToVicho += (item.amount / 2);

                const state = determineState(item);
                const isHouse = item.type === 'house';
                
                const div = document.createElement('div');
                div.className = `bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden ${state.cardClass} transition-all duration-300`;
                
                const deleteBtn = `<button onclick="deleteExp('${item.id}')" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>`;

                let checksHTML = '';
                if (isHouse) {
                    checksHTML = `
                        <div class="flex gap-2 mt-3 pt-3 border-t border-slate-100/50">
                            <!-- Bot贸n 1: Pagar Cuenta -->
                            <button onclick="toggleProvider('${item.id}', ${item.paidProvider})" class="flex-1 py-2.5 rounded-xl text-xs font-bold border flex items-center justify-center gap-2 check-btn ${item.paidProvider ? 'check-active' : 'check-inactive'}">
                                <i class="fas fa-file-invoice-dollar"></i> ${item.paidProvider ? 'Cta Pagada' : 'Pagar Cta'}
                            </button>
                            <!-- Bot贸n 2: Reembolso -->
                            <button onclick="toggleReimbursement('${item.id}', ${item.paidReimbursement})" class="flex-1 py-2.5 rounded-xl text-xs font-bold border flex items-center justify-center gap-2 check-btn ${item.paidReimbursement ? 'check-active' : 'check-inactive'}">
                                <i class="fas fa-exchange-alt"></i> ${item.paidReimbursement ? 'Reembolsado' : 'Falta Dep贸sito'}
                            </button>
                        </div>
                    `;
                } else {
                    checksHTML = `
                        <div class="mt-2">
                             <button onclick="toggleProvider('${item.id}', ${item.paidProvider})" class="w-full py-2 rounded-xl text-xs font-bold border flex items-center justify-center gap-2 check-btn ${item.paidProvider ? 'check-active' : 'check-inactive'}">
                                <i class="fas fa-check"></i> ${item.paidProvider ? 'Pagado' : 'Marcar Pagado'}
                            </button>
                        </div>
                    `;
                }

                div.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-slate-700 text-lg leading-tight">${item.name}</h3>
                                <p class="text-xs font-mono font-bold text-slate-400 mt-0.5">${formatMoney(item.amount)} Total</p>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 rounded text-[9px] font-bold uppercase tracking-wider ${state.badgeClass}">${state.label}</span>
                                <div class="mt-1">${deleteBtn}</div>
                            </div>
                        </div>
                        ${isHouse ? `<p class="text-xs text-indigo-600 font-bold mb-1 ml-1"><i class="fas fa-user-friends mr-1"></i> ${formatMoney(item.amount/2)} c/u</p>` : ''}
                        ${checksHTML}
                    </div>
                `;
                container.appendChild(div);
            });

            document.getElementById('debtAmount').textContent = formatMoney(totalDebtToVicho);
        }

        // --- LGICA DE ESTADOS ---
        function determineState(item) {
            if (item.type !== 'house') {
                return item.paidProvider 
                    ? { cardClass: 'card-green', badgeClass: 'badge-green', label: 'LISTO' }
                    : { cardClass: 'card-red', badgeClass: 'badge-red', label: 'PENDIENTE' };
            }

            const prov = item.paidProvider;
            const reimb = item.paidReimbursement;

            // 1. ROJO: Nada (Prioridad Media)
            if (!prov && !reimb) return { cardClass: 'card-red', badgeClass: 'badge-red', label: 'IMPAGO' };
            
            // 2. AMARILLO: Carlos pag贸, Falta Cuenta (Prioridad Alta - Alerta)
            if (!prov && reimb) return { cardClass: 'card-yellow', badgeClass: 'badge-yellow', label: 'FALTA CTA' };
            
            // 3. AZUL: Vicho pag贸, Falta Reembolso (Prioridad Media - Espera)
            if (prov && !reimb) return { cardClass: 'card-blue', badgeClass: 'badge-blue', label: 'FALTA DEPSITO' };
            
            // 4. VERDE: Todo listo (Prioridad Baja)
            if (prov && reimb) return { cardClass: 'card-green', badgeClass: 'badge-green', label: 'CERRADO' };
        }

        function getStatusScore(item) {
             const s = determineState(item);
             if (s.cardClass === 'card-yellow') return 1; // Urgente
             if (s.cardClass === 'card-blue') return 2;   // Espera
             if (s.cardClass === 'card-red') return 3;    // Pendiente normal
             return 4; // Cerrado
        }

        // --- ACCIONES ---
        window.changeMonth = () => { selectedMonth = document.getElementById('monthSelector').value; listenData(); };

        window.prefill = (name, amount, isHouse) => {
            document.getElementById('inputName').value = name;
            document.getElementById('inputAmount').value = amount;
            const radios = document.getElementsByName('expType');
            radios.forEach(r => { if(r.value === (isHouse ? 'house' : 'personal')) r.checked = true; });
            if(!amount) document.getElementById('inputAmount').focus();
        };

        window.saveExpense = async () => {
            const name = document.getElementById('inputName').value;
            const amount = parseInt(document.getElementById('inputAmount').value);
            const type = document.querySelector('input[name="expType"]:checked').value;
            const btn = document.getElementById('saveBtn');

            if(!name || isNaN(amount)) return showToast("Datos incompletos");
            btn.disabled = true;

            try {
                await addDoc(collection(db, "gastos"), {
                    userId: currentUser.email,
                    name: name,
                    amount: amount,
                    type: type, 
                    month: selectedMonth,
                    paidProvider: false,      
                    paidReimbursement: false, 
                    date: Date.now()
                });
                
                if(type === 'house') await updateDefaultPrice(name, amount);
                
                document.getElementById('inputName').value = '';
                document.getElementById('inputAmount').value = '';
                showToast("Guardado");
            } catch(e) { 
                console.error(e); 
                showError("Error al guardar: " + e.message);
            }
            btn.disabled = false;
        };

        window.toggleProvider = async (id, status) => { await updateDoc(doc(db, "gastos", id), { paidProvider: !status }); };
        window.toggleReimbursement = async (id, status) => { await updateDoc(doc(db, "gastos", id), { paidReimbursement: !status }); };
        window.deleteExp = async (id) => { if(confirm("驴Eliminar?")) await deleteDoc(doc(db, "gastos", id)); };

        // Helpers
        function formatMoney(val) { return new Intl.NumberFormat('es-CL', {style:'currency', currency:'CLP', maximumFractionDigits:0}).format(val); }
        function showToast(msg) {
            const t = document.getElementById('toast'); t.textContent = msg;
            t.classList.remove('-translate-y-4', 'opacity-0');
            setTimeout(() => t.classList.add('-translate-y-4', 'opacity-0'), 3000);
        }
        function showError(msg) {
            document.getElementById('errorMsg').textContent = msg;
            document.getElementById('errorAlert').classList.remove('hidden');
        }

        // Exponer globalmente
        window.changeMonth = window.changeMonth;
        window.prefill = window.prefill;
        window.saveExpense = window.saveExpense;
        window.toggleProvider = window.toggleProvider;
        window.toggleReimbursement = window.toggleReimbursement;
        window.deleteExp = window.deleteExp;
    </script>
</body>
</html>


