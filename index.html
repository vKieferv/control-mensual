<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Suite v34</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-view { display: none !important; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* Tarjeta de Notificación */
        .card-request { background: #fff7ed; border-left: 6px solid #f97316; }
        
        /* Semáforo Hogar */
        .sync-red { border-left: 6px solid #ef4444; background: #fff; }
        .sync-yellow { border-left: 6px solid #f59e0b; background: #fffbeb; }
        .sync-green { border-left: 6px solid #22c55e; background: #f0fdf4; opacity: 0.8; }

        /* Estado Personal */
        .card-personal-pending { background: white; border: 1px solid #e2e8f0; border-left: 4px solid #cbd5e1; }
        .card-personal-done { background: #f0fdf4; border: 1px solid #dcfce7; border-left: 4px solid #22c55e; color: #166534; }

        /* Botones Selección */
        .btn-select.selected { background-color: #4f46e5; color: white; border-color: #4f46e5; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800">

    <!-- LOGIN -->
    <div id="view-login" class="flex flex-col items-center justify-center min-h-screen p-6 fade-in">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center border border-slate-100">
            <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-wallet text-4xl text-indigo-600"></i>
            </div>
            <h1 class="text-3xl font-extrabold text-slate-800 mb-2">Finanzas Suite</h1>
            <p class="text-slate-400 text-sm mb-8">Gestión Inteligente</p>
            <button onclick="loginWithGoogle()" class="w-full bg-white border border-slate-300 text-slate-700 font-bold py-4 rounded-xl shadow-sm hover:bg-slate-50 flex items-center justify-center gap-3 transition active:scale-95 group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 group-hover:scale-110 transition">
                Entrar con Google
            </button>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="view-app" class="hidden-view pb-32 fade-in">
        
        <!-- Navbar -->
        <nav class="bg-white sticky top-0 z-30 px-5 py-4 shadow-sm border-b border-slate-100 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img id="userPhoto" src="" class="w-10 h-10 rounded-full border-2 border-slate-200">
                <div class="leading-tight">
                    <p class="text-[10px] uppercase font-bold text-slate-400">Hola</p>
                    <p id="userName" class="font-bold text-slate-800 text-sm">Usuario</p>
                </div>
            </div>
            <div class="flex gap-2 items-center">
                <button onclick="exportTextReport()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-download text-xs"></i></button>
                <div class="bg-slate-100 rounded-lg px-2 py-1">
                    <input type="month" id="monthSelector" class="bg-transparent text-xs font-bold text-slate-600 outline-none cursor-pointer" onchange="changeMonth()">
                </div>
            </div>
        </nav>

        <main class="p-5 max-w-6xl mx-auto space-y-6">

            <!-- 1. BUZÓN DE APROBACIONES -->
            <div id="requestsPanel" class="hidden space-y-3">
                <div class="flex items-center gap-2 px-1 animate-pulse">
                    <span class="w-2 h-2 rounded-full bg-orange-500"></span>
                    <h3 class="text-xs font-bold text-orange-600 uppercase tracking-widest">Requiere tu Aprobación</h3>
                </div>
                <div id="requestsList" class="space-y-3"></div>
            </div>

            <!-- 2. SUELDO -->
            <div class="bg-slate-800 p-6 rounded-3xl shadow-lg relative overflow-hidden text-white">
                <div class="absolute top-0 right-0 p-4 opacity-10"><i class="fas fa-money-bill-wave text-6xl"></i></div>
                
                <div class="flex justify-between items-start mb-4 relative z-10">
                    <div>
                        <p class="text-slate-400 text-xs font-bold uppercase tracking-widest mb-1">Sueldo Líquido</p>
                        <div class="flex items-center gap-2">
                            <span class="text-slate-400 text-xl">$</span>
                            <input type="number" id="salaryInput" class="bg-transparent text-3xl font-extrabold text-white w-40 outline-none border-b border-slate-600 focus:border-emerald-400 transition" placeholder="0" onchange="updateSalary()">
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-400 uppercase font-bold">Disponible Real</p>
                        <p class="text-2xl font-bold text-emerald-400" id="salaryRemaining">$0</p>
                    </div>
                </div>
                <!-- Barra -->
                <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                    <div id="salaryBar" class="h-full bg-emerald-500 transition-all duration-700" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase">
                    <span>Gastado (Pagado): <span id="salarySpent" class="text-white">$0</span></span>
                    <span id="salaryPercent">0%</span>
                </div>
            </div>

            <!-- 3. PANEL DE ACCIÓN -->
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 relative z-10">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Nuevo Movimiento</p>
                    <span id="loadingDefaults" class="text-[10px] text-blue-500 animate-pulse hidden">Sync...</span>
                </div>
                
                <!-- Botones Dinámicos -->
                <div id="smartButtons" class="flex gap-2 overflow-x-auto hide-scroll mb-4 pb-1"></div>

                <!-- Toggle Tipo -->
                <div class="flex gap-2 mb-4">
                    <button onclick="setMode('personal')" id="btnModePersonal" class="flex-1 py-3 rounded-xl border-2 text-xs font-bold transition flex flex-col items-center justify-center gap-1 border-emerald-500 bg-emerald-50 text-emerald-700">
                        <i class="fas fa-user"></i> Mío
                    </button>
                    <button onclick="setMode('house')" id="btnModeHouse" class="flex-1 py-3 rounded-xl border-2 text-xs font-bold transition flex flex-col items-center justify-center gap-1 border-slate-100 text-slate-400">
                        <i class="fas fa-home"></i> Casa (Split)
                    </button>
                    <button onclick="setMode('custom')" id="btnModeCustom" class="flex-1 py-3 rounded-xl border-2 text-xs font-bold transition flex flex-col items-center justify-center gap-1 border-slate-100 text-slate-400">
                        <i class="fas fa-users"></i> Grupo
                    </button>
                </div>

                <!-- Info Split Casa -->
                <div id="houseSplitInfo" class="hidden mb-4 bg-indigo-50 p-3 rounded-xl border border-indigo-100 text-xs text-indigo-800">
                    <p class="font-bold mb-1"><i class="fas fa-info-circle"></i> Distribución Automática:</p>
                    <ul class="list-disc list-inside opacity-80">
                        <li>Carlos: 50%</li>
                        <li>Vicente: 25%</li>
                        <li>Anabel: 25%</li>
                    </ul>
                </div>

                <!-- Selector Grupo -->
                <div id="customGroupSelector" class="hidden mb-4 bg-slate-50 p-3 rounded-xl">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">Solicitar a:</p>
                    <div class="flex gap-2 flex-wrap" id="participantsContainer"></div>
                </div>

                <!-- Inputs -->
                <div class="flex gap-3">
                    <input type="text" id="inputName" placeholder="Concepto" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-indigo-100 transition">
                    <input type="number" id="inputAmount" placeholder="$ Total" class="w-1/3 p-3 bg-slate-50 rounded-xl font-bold text-center text-sm outline-none focus:ring-2 focus:ring-indigo-100 transition">
                </div>
                
                <button onclick="saveExpense()" class="w-full mt-3 bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-black transition shadow-lg active:scale-95">
                    <i class="fas fa-plus mr-2"></i> Procesar Gasto
                </button>
                <input type="hidden" id="currentMode" value="personal">
            </div>

            <!-- 4. LISTAS -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- GASTOS HOGAR -->
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest px-2">Estado del Hogar</h3>
                    <div id="houseList" class="space-y-3"></div>
                </div>

                <!-- MIS PAGOS -->
                <div class="space-y-4">
                    <div class="flex justify-between px-2">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest">Mis Pagos</h3>
                        <span id="totalPersonal" class="text-xs font-bold text-emerald-600">$0</span>
                    </div>
                    <div id="personalList" class="space-y-3"></div>
                </div>

            </div>

        </main>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl text-xs font-bold opacity-0 transition-all pointer-events-none z-50 -translate-y-4 flex items-center gap-2">
        <span id="toastMsg">Mensaje</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, updateDoc, deleteDoc, setDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ==========================================
        // 1. TUS CREDENCIALES (PEGA AQUÍ)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyALsMoeqqLpQge9hMocUHSjmqnpJXNJ9p4",
            authDomain: "control-mensual-ae833.firebaseapp.com",
            projectId: "control-mensual-ae833",
            storageBucket: "control-mensual-ae833.firebasestorage.app",
            messagingSenderId: "909368343478",
            appId: "1:909368343478:web:0733b7a0a57cec5893df17"
        };

        // ==========================================
        // 2. CONFIGURACIÓN FAMILIA (IMPORTANTE)
        // ==========================================
        const EMAILS = {
            VICENTE: 'vicente8sanchez@gmail.com',
            CARLOS:  'carlosinvictus50@gmail.com',
            ANABEL:  'anabellc.nc@gmail.com',
            JP:      'juanpapino10@gmail.com'
        };

        const USERS = [
            { email: EMAILS.VICENTE, name: 'Vicente', role: 'admin' },
            { email: EMAILS.CARLOS,  name: 'Carlos',  role: 'partner' },
            { email: EMAILS.ANABEL,  name: 'Anabel',  role: 'user' },
            { email: EMAILS.JP,      name: 'JP',      role: 'user' }
        ];

        // Definimos quiénes pagan el gasto de casa y cuánto
        const HOUSE_SPLIT = [
            { email: EMAILS.CARLOS,  percent: 0.50 }, // 50%
            { email: EMAILS.VICENTE, percent: 0.25 }, // 25%
            { email: EMAILS.ANABEL,  percent: 0.25 }  // 25%
        ];

        const HOUSE_ADMINS = [EMAILS.VICENTE, EMAILS.CARLOS]; 

        const BASE_SERVICES = [
            { name: 'Arriendo', amount: 350000, icon: 'fa-home' },
            { name: 'Luz', amount: 45000, icon: 'fa-lightbulb' },
            { name: 'Agua', amount: 25000, icon: 'fa-faucet' },
            { name: 'Gas', amount: 60000, icon: 'fa-fire' },
            { name: 'Internet', amount: 30000, icon: 'fa-wifi' },
            { name: 'GC', amount: 90000, icon: 'fa-building' }
        ];

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let selectedMonth = new Date().toISOString().slice(0, 7);
        let allData = [];
        let priceMemory = {};
        let salaryData = 0;
        let selectedParticipants = [];

        // AUTH
        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, provider); } catch(e){ alert(e.message); } };
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                const config = USERS.find(u => u.email === user.email);
                if (config) {
                    currentUser = { ...user, ...config };
                    initUI();
                } else {
                    alert("No autorizado"); signOut(auth);
                }
            } else {
                document.getElementById('view-app').classList.add('hidden-view');
                document.getElementById('view-login').classList.remove('hidden-view');
            }
        });

        async function initUI() {
            document.getElementById('view-login').classList.add('hidden-view');
            document.getElementById('view-app').classList.remove('hidden-view');
            document.getElementById('userPhoto').src = currentUser.photoURL;
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('monthSelector').value = selectedMonth;

            // Restricción de botones para usuarios
            if (currentUser.role === 'user') {
                document.getElementById('btnModeHouse').classList.add('hidden');
                window.setMode('personal');
            }

            renderParticipants(); 
            await loadSalary();
            await loadPriceMemory();
            listenData();
        }

        // --- GESTIÓN SALARIO ---
        async function loadSalary() {
            try {
                const docId = `salary_${currentUser.email}_${selectedMonth}`;
                const docSnap = await getDoc(doc(db, "salaries", docId));
                salaryData = docSnap.exists() ? docSnap.data().amount : 0;
                document.getElementById('salaryInput').value = salaryData > 0 ? salaryData : '';
                updateSalaryUI();
            } catch(e) {}
        }

        window.updateSalary = async () => {
            const amount = parseInt(document.getElementById('salaryInput').value) || 0;
            salaryData = amount;
            const docId = `salary_${currentUser.email}_${selectedMonth}`;
            await setDoc(doc(db, "salaries", docId), { amount: amount });
            updateSalaryUI();
        };

        function updateSalaryUI() {
            const myPaid = allData.filter(e => 
                e.userId === currentUser.email && 
                e.paid && 
                e.approvalStatus !== 'pending'
            );
            const spent = myPaid.reduce((sum, e) => sum + e.amount, 0);
            const remaining = salaryData - spent;
            const percent = salaryData > 0 ? (spent / salaryData) * 100 : 0;

            document.getElementById('salaryRemaining').textContent = formatMoney(remaining);
            document.getElementById('salarySpent').textContent = formatMoney(spent);
            document.getElementById('salaryPercent').textContent = `${Math.round(percent)}%`;
            document.getElementById('salaryBar').style.width = `${Math.min(percent, 100)}%`;
            
            const bar = document.getElementById('salaryBar');
            bar.style.backgroundColor = percent > 90 ? '#ef4444' : (percent > 60 ? '#f59e0b' : '#10b981');
        }

        // --- UI BOTONES ---
        window.setMode = (mode) => {
            document.getElementById('currentMode').value = mode;
            const btns = ['btnModePersonal', 'btnModeHouse', 'btnModeCustom'];
            btns.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.className = "flex-1 py-3 rounded-xl border-2 text-xs font-bold transition flex flex-col items-center justify-center gap-1 border-slate-100 text-slate-400";
            });
            
            document.getElementById('customGroupSelector').classList.add('hidden');
            document.getElementById('houseSplitInfo').classList.add('hidden');

            if (mode === 'personal') {
                document.getElementById('btnModePersonal').className = "flex-1 py-3 rounded-xl border-2 text-xs font-bold transition flex flex-col items-center justify-center gap-1 border-emerald-500 bg-emerald-50 text-emerald-700";
            } else if (mode === 'house') {
                document.getElementById('btnModeHouse').className = "flex-1 py-3 rounded-xl border-2 text-xs font-bold transition flex flex-col items-center justify-center gap-1 border-indigo-500 bg-indigo-50 text-indigo-700";
                document.getElementById('houseSplitInfo').classList.remove('hidden');
            } else if (mode === 'custom') {
                document.getElementById('btnModeCustom').className = "flex-1 py-3 rounded-xl border-2 text-xs font-bold transition flex flex-col items-center justify-center gap-1 border-purple-500 bg-purple-50 text-purple-700";
                document.getElementById('customGroupSelector').classList.remove('hidden');
            }
        };

        function renderParticipants() {
            const c = document.getElementById('participantsContainer'); c.innerHTML='';
            USERS.forEach(u => {
                if(u.email === currentUser.email) return; 
                const btn = document.createElement('button');
                btn.className = "btn-select px-3 py-2 rounded-lg border bg-white text-xs font-bold text-slate-500";
                btn.textContent = u.name;
                btn.onclick = () => {
                    btn.classList.toggle('selected');
                    if(btn.classList.contains('selected')) selectedParticipants.push(u.email);
                    else selectedParticipants = selectedParticipants.filter(e => e !== u.email);
                };
                c.appendChild(btn);
            });
        }

        // --- CORE DATA ---
        window.changeMonth = () => { selectedMonth = document.getElementById('monthSelector').value; loadSalary(); listenData(); };

        function listenData() {
            const q = query(collection(db, "gastos"), where("month", "==", selectedMonth));
            onSnapshot(q, (snapshot) => {
                allData = [];
                snapshot.forEach(doc => allData.push({ id: doc.id, ...doc.data() }));
                renderLists();
                updateSalaryUI();
            });
        }

        function renderLists() {
            const houseList = document.getElementById('houseList');
            const personalList = document.getElementById('personalList');
            const requestsList = document.getElementById('requestsList');
            const requestsPanel = document.getElementById('requestsPanel');
            
            houseList.innerHTML = ''; personalList.innerHTML = ''; requestsList.innerHTML = '';
            let hasRequests = false; let sumPersonal = 0;

            const myExpenses = allData.filter(e => e.type === 'house' || e.userId === currentUser.email);

            myExpenses.forEach(item => {
                const isHouse = item.type === 'house';
                const isMine = item.userId === currentUser.email;
                const isPending = item.approvalStatus === 'pending';

                // 1. SOLICITUDES
                if (isMine && isPending) {
                    hasRequests = true;
                    const div = document.createElement('div');
                    div.className = "card-request p-4 rounded-xl flex justify-between items-center shadow-sm";
                    div.innerHTML = `
                        <div>
                            <p class="text-[10px] font-bold text-orange-600 uppercase">Solicitud de ${item.requesterName || 'Alguien'}</p>
                            <h4 class="font-bold text-slate-800">${item.name}</h4>
                            <p class="text-xs font-mono font-bold text-slate-500">${formatMoney(item.amount)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="deleteItem('${item.id}', false)" class="w-8 h-8 rounded-full bg-white text-red-500 flex items-center justify-center hover:bg-red-50"><i class="fas fa-times"></i></button>
                            <button onclick="approveItem('${item.id}')" class="w-8 h-8 rounded-full bg-white text-green-500 flex items-center justify-center hover:bg-green-50 shadow-sm"><i class="fas fa-check"></i></button>
                        </div>
                    `;
                    requestsList.appendChild(div);
                    return; 
                }

                // 2. PANEL HOGAR
                if (isHouse && item.isParent) {
                    const parts = allData.filter(sub => sub.parentId === item.id);
                    const paidCount = parts.filter(sub => sub.paid).length;
                    
                    let statusClass = 'sync-red'; let text = `0/${parts.length}`; let badge = 'badge-red';
                    if (paidCount > 0 && paidCount < parts.length) { statusClass = 'sync-yellow'; text = 'PARCIAL'; badge = 'badge-yellow'; }
                    else if (paidCount === parts.length && parts.length > 0) { statusClass = 'sync-green'; text = 'LISTO'; badge = 'badge-green'; }

                    const div = document.createElement('div');
                    div.className = `p-4 rounded-2xl border shadow-sm transition ${statusClass} relative`;
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-slate-700 leading-tight">${item.name}</h4>
                                <p class="text-xs font-mono font-bold text-slate-400 mt-1">${formatMoney(item.amount)}</p>
                            </div>
                            <span class="px-2 py-1 rounded text-[9px] font-bold uppercase bg-white/50">${text}</span>
                        </div>
                        ${(HOUSE_ADMINS.includes(currentUser.email)) ? `<button onclick="deleteGlobal('${item.id}')" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full transition"><i class="fas fa-trash-alt text-xs"></i></button>` : ''}
                    `;
                    houseList.appendChild(div);
                }

                // 3. PANEL PERSONAL
                if (isMine && !item.isParent && !isPending) {
                    sumPersonal += item.amount;
                    const div = document.createElement('div');
                    const paidClass = item.paid ? 'card-personal-done' : 'card-personal-pending';
                    const icon = isHouse ? 'fa-home' : 'fa-user';
                    
                    let statusLabel = '';
                    if (item.type === 'custom_out' && item.approvalStatus === 'pending') statusLabel = '<span class="text-[9px] bg-orange-100 text-orange-600 px-1 rounded ml-2">Esperando...</span>';

                    div.className = `p-3 rounded-2xl border flex justify-between items-center shadow-sm cursor-pointer transition ${paidClass}`;
                    div.onclick = (e) => { if(!e.target.closest('button')) togglePaid(item.id, item.paid); };

                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <i class="fas ${item.paid ? 'fa-check-circle text-emerald-600' : icon} text-lg opacity-70"></i>
                            <div>
                                <p class="font-bold text-sm text-slate-700 ${item.paid ? 'line-through opacity-50' : ''}">${item.name}</p>
                                <p class="text-xs font-mono font-bold text-slate-500">${formatMoney(item.amount)} ${statusLabel}</p>
                            </div>
                        </div>
                        ${(!isHouse) ? `<button onclick="deleteItem('${item.id}')" class="text-slate-300 hover:text-red-500 text-xs"><i class="fas fa-trash"></i></button>` : ''}
                    `;
                    personalList.appendChild(div);
                }
            });

            document.getElementById('totalPersonal').textContent = formatMoney(sumPersonal);
            if (hasRequests) requestsPanel.classList.remove('hidden'); else requestsPanel.classList.add('hidden');
        }

        // --- ACCIONES ---
        window.saveExpense = async () => {
            const name = document.getElementById('inputName').value;
            const amount = parseInt(document.getElementById('inputAmount').value);
            const mode = document.getElementById('currentMode').value;

            if(!name || isNaN(amount)) return showToast("Falta info");

            const batch = writeBatch(db);
            const date = Date.now();

            if (mode === 'house') {
                if (!HOUSE_ADMINS.includes(currentUser.email)) return alert("Solo Admins");
                
                const parentRef = doc(collection(db, "gastos"));
                batch.set(parentRef, { name, amount, type: 'house', isParent: true, userId: 'HOUSE', month: selectedMonth, date });

                HOUSE_SPLIT.forEach(userCfg => {
                    const childRef = doc(collection(db, "gastos"));
                    batch.set(childRef, {
                        name, amount: Math.ceil(amount * userCfg.percent), type: 'house', isParent: false, parentId: parentRef.id,
                        userId: userCfg.email, month: selectedMonth, paid: false, date, approvalStatus: 'approved'
                    });
                });
                await learnPrice(name, amount);
            } 
            else if (mode === 'personal') {
                await addDoc(collection(db, "gastos"), { name, amount, type: 'personal', userId: currentUser.email, month: selectedMonth, paid: false, date, approvalStatus: 'approved' });
            }
            else if (mode === 'custom') {
                const participants = [currentUser.email, ...selectedParticipants];
                const partAmount = Math.ceil(amount / participants.length);
                participants.forEach(email => {
                    const isMe = email === currentUser.email;
                    const ref = doc(collection(db, "gastos"));
                    batch.set(ref, {
                        name: `${name} (Grupo)`, amount: partAmount, type: isMe ? 'personal' : 'custom_out', userId: email,
                        month: selectedMonth, paid: false, date, requesterName: currentUser.name, approvalStatus: isMe ? 'approved' : 'pending'
                    });
                });
            }

            await batch.commit();
            document.getElementById('inputName').value = ''; document.getElementById('inputAmount').value = ''; selectedParticipants = []; renderParticipants();
            showToast("Guardado");
        };

        window.approveItem = async (id) => { await updateDoc(doc(db, "gastos", id), { approvalStatus: 'approved' }); showToast("Aprobado"); };
        window.togglePaid = async (id, s) => { await updateDoc(doc(db, "gastos", id), { paid: !s }); };
        window.deleteItem = async (id) => { if(confirm("¿Eliminar?")) await deleteDoc(doc(db, "gastos", id)); };
        window.deleteGlobal = async (pid) => { if(confirm("¿Borrar todo?")) { const b = writeBatch(db); b.delete(doc(db, "gastos", pid)); allData.filter(d=>d.parentId===pid).forEach(c=>b.delete(doc(db,"gastos",c.id))); await b.commit(); }};

        async function loadPriceMemory() { try { const s = await getDoc(doc(db, "config", "precios_aprendidos")); if(s.exists()) priceMemory = s.data(); else BASE_SERVICES.forEach(s=>priceMemory[s.name]=s.amount); renderSmartButtons(); } catch(e){} }
        async function learnPrice(name, amount) { priceMemory[name]=amount; try{await setDoc(doc(db,"config","precios_aprendidos"),priceMemory);renderSmartButtons();}catch(e){} }
        
        function renderSmartButtons() {
            const c = document.getElementById('smartButtons'); c.innerHTML='';
            BASE_SERVICES.forEach(s=>{
                const amt = priceMemory[s.name]||s.amount;
                const btn = document.createElement('button');
                btn.className = "flex-shrink-0 bg-white border border-slate-200 text-slate-600 px-3 py-2 rounded-xl text-xs font-bold shadow-sm hover:border-indigo-300 hover:text-indigo-600 transition active:scale-95 flex flex-col items-center min-w-[70px]";
                btn.onclick = () => prefill(s.name, amt);
                btn.innerHTML = `<i class="fas ${s.icon} text-lg mb-1 opacity-50"></i><span>${s.name}</span><span class="text-[9px] font-mono text-slate-400 mt-0.5">$${Math.round(amt/1000)}k</span>`;
                c.appendChild(btn);
            });
        }
        window.prefill = (n,a) => { document.getElementById('inputName').value=n; document.getElementById('inputAmount').value=a; window.setMode('house'); };
        
        window.exportTextReport = () => {
            if(allData.length===0) return showToast("Nada");
            let t = `REPORTE ${selectedMonth}\n================\n`;
            allData.forEach(e => { if((e.isParent && e.type==='house')||(e.type!=='house'&&e.userId===currentUser.email)) t+=`${e.paid?'[OK]':'[  ]'} ${e.name} $${e.amount}\n`; });
            const b = new Blob([t], {type:'text/plain'});
            const l = document.createElement("a"); l.href=URL.createObjectURL(b); l.download=`Reporte.txt`; l.click();
        };

        function formatMoney(v) { return new Intl.NumberFormat('es-CL', {style:'currency', currency:'CLP', maximumFractionDigits:0}).format(v); }
        function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.remove('-translate-y-4','opacity-0'); setTimeout(()=>t.classList.add('-translate-y-4','opacity-0'),3000); }
    </script>
</body>
</html>
