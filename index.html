<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gastos Casa (Google)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-view { display: none !important; }
        .google-btn { transition: all 0.2s; }
        .google-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">

    <!-- LOGIN CON GOOGLE -->
    <div id="view-login" class="flex flex-col items-center justify-center min-h-screen p-6 fade-in">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center border border-slate-100">
            <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-shield-alt text-4xl text-blue-600"></i>
            </div>
            <h1 class="text-3xl font-extrabold text-slate-800 mb-2">Acceso Seguro</h1>
            <p class="text-slate-400 text-sm mb-8">Gestión de Gastos Familiares</p>

            <button onclick="loginWithGoogle()" class="google-btn w-full bg-white border border-slate-300 text-slate-700 font-bold py-4 rounded-xl shadow-sm hover:bg-slate-50 flex items-center justify-center gap-3">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                Entrar con Google
            </button>
            
            <p id="login-error" class="text-red-500 text-xs mt-4 hidden"></p>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="view-app" class="hidden-view pb-24 fade-in">
        
        <!-- Navbar -->
        <nav class="bg-white sticky top-0 z-30 px-5 py-3 flex justify-between items-center shadow-sm border-b border-slate-100">
            <div class="flex items-center gap-3">
                <img id="userPhoto" src="" class="w-10 h-10 rounded-full border-2 border-slate-200">
                <div class="leading-tight">
                    <p class="text-[10px] uppercase font-bold text-slate-400">Hola,</p>
                    <p id="userName" class="font-bold text-slate-800 text-sm">Usuario</p>
                </div>
            </div>
            <button onclick="logout()" class="text-slate-400 hover:text-red-500 transition">
                <i class="fas fa-sign-out-alt text-xl"></i>
            </button>
        </nav>

        <main class="p-5 max-w-2xl mx-auto space-y-6">
            
            <!-- PANEL ADMIN (Solo visible para correos Admin) -->
            <div id="admin-panel" class="hidden-view space-y-4">
                <div class="bg-slate-800 p-6 rounded-3xl shadow-lg text-white relative overflow-hidden">
                    <i class="fas fa-chart-pie absolute -right-4 -top-4 text-8xl text-white opacity-5"></i>
                    <p class="text-slate-400 text-xs font-bold uppercase">Total Casa</p>
                    <h2 class="text-4xl font-extrabold my-1" id="houseTotal">$0</h2>
                    <div class="flex gap-4 mt-4 text-xs font-bold">
                        <span class="bg-red-500/20 text-red-200 px-3 py-1 rounded-lg">Por Pagar: <span id="housePending">...</span></span>
                        <span class="bg-emerald-500/20 text-emerald-200 px-3 py-1 rounded-lg">Pagado: <span id="housePaid">...</span></span>
                    </div>
                </div>

                <!-- Lista de Integrantes -->
                <div>
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 px-1">Integrantes</h3>
                    <div id="usersList" class="grid grid-cols-1 gap-3"></div>
                </div>
                
                <div class="h-px bg-slate-200 w-full"></div>
            </div>

            <!-- PANEL PERSONAL -->
            <div id="personal-panel">
                <!-- Header dinámico (cambia si Admin ve a otro) -->
                <div id="personalHeader" class="flex justify-between items-end mb-2 hidden-view">
                     <button onclick="showMyView()" class="text-xs bg-slate-200 px-3 py-1 rounded-full font-bold text-slate-600"><i class="fas fa-arrow-left"></i> Volver a mí</button>
                     <span class="text-xs font-bold text-blue-600 uppercase" id="viewingName">Viendo a X</span>
                </div>

                <div class="bg-emerald-600 p-6 rounded-3xl shadow-lg text-white mb-6 transition-colors duration-300" id="personalCard">
                    <p class="text-emerald-100 text-xs font-bold uppercase">Mis Gastos</p>
                    <h2 class="text-4xl font-extrabold mt-1" id="myTotal">$0</h2>
                    <p class="text-right text-emerald-100 text-xs font-bold mt-2" id="myPendingText">Deuda: $0</p>
                    <div class="w-full bg-black/20 h-1.5 rounded-full mt-2">
                        <div id="myProgressBar" class="bg-white h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Formulario -->
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-6">
                    <div class="flex gap-3">
                        <input type="text" id="inputName" placeholder="Ej: Supermercado" class="w-full p-3 bg-slate-50 rounded-xl font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="number" id="inputAmount" placeholder="$" class="w-1/3 p-3 bg-slate-50 rounded-xl font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500 text-center">
                    </div>
                    <button id="btnAdd" onclick="addExpense()" class="w-full mt-3 bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-black transition flex justify-center gap-2">
                        <span>Guardar</span> <i class="fas fa-cloud-upload-alt"></i>
                    </button>
                </div>

                <!-- Lista -->
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3 px-1">Movimientos</h3>
                <div id="expensesList" class="space-y-3 pb-20">
                    <div class="text-center py-10 text-slate-400 text-sm">Cargando...</div>
                </div>
            </div>
        </main>
        
        <!-- Reset Mes (Solo Admin) -->
        <button onclick="resetMonth()" id="adminResetBtn" class="hidden-view fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-2xl flex items-center justify-center text-xl hover:scale-110 transition z-40">
            <i class="fas fa-calendar-check"></i>
        </button>
    </div>

    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl text-sm font-bold opacity-0 transition-all pointer-events-none z-50 transform -translate-y-4">Mensaje</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // =================================================================
        // 1. CONFIGURACIÓN DE FIREBASE (PEGA TUS CLAVES AQUÍ)
        // =================================================================
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            projectId: "TU_PROYECTO_ID",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "NUMEROS",
            appId: "TU_APP_ID"
        };

        // =================================================================
        // 2. CONFIGURACIÓN DE FAMILIA (EDITA LOS CORREOS AQUÍ)
        // =================================================================
        // Escribe los correos EXACTOS de Gmail de tu familia.
        
        const FAMILY_CONFIG = {
            // CORREOS ADMINISTRADORES (Ven todo)
            'TU_CORREO_ADMIN@gmail.com': { role: 'admin', label: 'Papá Admin' },
            
            // CORREOS USUARIOS (Ven solo lo suyo)
            'CORREO_ESPOSA@gmail.com':   { role: 'user', label: 'Mamá' },
            'CORREO_HIJO@gmail.com':     { role: 'user', label: 'Hijo' },
            'CORREO_OTRO@gmail.com':     { role: 'user', label: 'Otro' }
        };

        // =================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null; // Objeto de Google
        let userRole = 'guest'; // 'admin' | 'user' | 'guest'
        let allExpenses = [];
        let viewFilterEmail = null; // Si es null, veo lo mío. Si tiene email, veo ese email (solo admin)

        // --- AUTH ---
        window.loginWithGoogle = async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                document.getElementById('login-error').textContent = error.message;
                document.getElementById('login-error').classList.remove('hidden');
            }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Verificar si el correo está en la lista permitida
                const config = FAMILY_CONFIG[user.email];
                
                if (config) {
                    currentUser = user;
                    userRole = config.role;
                    // Agregar etiqueta personalizada al objeto user
                    currentUser.familyLabel = config.label; 
                    initApp();
                } else {
                    // Correo no autorizado
                    alert("Este correo no está autorizado en la familia.");
                    signOut(auth);
                }
            } else {
                document.getElementById('view-app').classList.add('hidden-view');
                document.getElementById('view-login').classList.remove('hidden-view');
            }
        });

        // --- LÓGICA APP ---
        function initApp() {
            document.getElementById('view-login').classList.add('hidden-view');
            document.getElementById('view-app').classList.remove('hidden-view');
            
            document.getElementById('userPhoto').src = currentUser.photoURL;
            document.getElementById('userName').textContent = currentUser.familyLabel; // Usar nombre de config

            if (userRole === 'admin') {
                document.getElementById('admin-panel').classList.remove('hidden-view');
                document.getElementById('adminResetBtn').classList.remove('hidden-view');
            } else {
                document.getElementById('admin-panel').classList.add('hidden-view');
                document.getElementById('adminResetBtn').classList.add('hidden-view');
            }

            viewFilterEmail = currentUser.email; // Por defecto veo lo mío
            listenData();
        }

        function listenData() {
            const q = query(collection(db, "gastos"));
            onSnapshot(q, (snapshot) => {
                allExpenses = [];
                snapshot.forEach((doc) => allExpenses.push({ id: doc.id, ...doc.data() }));
                renderUI();
            });
        }

        function renderUI() {
            if (userRole === 'admin') renderAdminSummary();
            renderPersonalView();
        }

        function renderAdminSummary() {
            // Calcular totales globales
            const total = allExpenses.reduce((s, e) => s + e.amount, 0);
            const paid = allExpenses.filter(e => e.paid).reduce((s, e) => s + e.amount, 0);
            
            document.getElementById('houseTotal').textContent = formatMoney(total);
            document.getElementById('housePending').textContent = formatMoney(total - paid);
            document.getElementById('housePaid').textContent = formatMoney(paid);

            // Renderizar lista de integrantes
            const list = document.getElementById('usersList');
            list.innerHTML = '';

            // Recorremos la CONFIGURACIÓN para mostrar a todos, incluso si no han gastado nada
            for (const [email, config] of Object.entries(FAMILY_CONFIG)) {
                // Filtrar gastos de este email
                const uExps = allExpenses.filter(e => e.userEmail === email);
                const uTotal = uExps.reduce((s, e) => s + e.amount, 0);
                
                const div = document.createElement('div');
                div.className = "bg-slate-700 p-3 rounded-xl flex justify-between items-center cursor-pointer hover:bg-slate-600 transition";
                div.onclick = () => { viewFilterEmail = email; renderUI(); }; // Al clic, filtrar por este email

                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-500 flex items-center justify-center font-bold text-xs text-white">
                            ${config.label.charAt(0)}
                        </div>
                        <div>
                            <p class="text-sm font-bold text-white">${config.label}</p>
                            <p class="text-[10px] text-slate-400">${uExps.length} items</p>
                        </div>
                    </div>
                    <span class="font-bold text-white">${formatMoney(uTotal)}</span>
                `;
                list.appendChild(div);
            }
        }

        function renderPersonalView() {
            const isMe = viewFilterEmail === currentUser.email;
            const targetConfig = FAMILY_CONFIG[viewFilterEmail];
            
            // Header visual
            const header = document.getElementById('personalHeader');
            if (!isMe) {
                header.classList.remove('hidden-view');
                document.getElementById('viewingName').textContent = `Viendo a: ${targetConfig.label}`;
                document.getElementById('personalCard').className = "bg-slate-700 p-6 rounded-3xl shadow-lg text-white mb-6"; // Color diferente para auditoría
            } else {
                header.classList.add('hidden-view');
                document.getElementById('personalCard').className = "bg-emerald-600 p-6 rounded-3xl shadow-lg text-white mb-6"; // Color normal
            }

            // Filtramos gastos
            const myData = allExpenses.filter(e => e.userEmail === viewFilterEmail);
            
            // Cálculos
            const total = myData.reduce((s, e) => s + e.amount, 0);
            const paid = myData.filter(e => e.paid).reduce((s, e) => s + e.amount, 0);
            const pending = total - paid;
            const percent = total > 0 ? (paid/total)*100 : 0;

            document.getElementById('myTotal').textContent = formatMoney(total);
            document.getElementById('myPendingText').textContent = `Deuda: ${formatMoney(pending)}`;
            document.getElementById('myProgressBar').style.width = `${percent}%`;

            // Lista
            const list = document.getElementById('expensesList');
            list.innerHTML = '';
            
            myData.sort((a,b) => a.paid - b.paid); // Pendientes primero

            if (myData.length === 0) {
                list.innerHTML = '<div class="text-center py-8 text-slate-400 text-xs">Sin gastos</div>';
                return;
            }

            myData.forEach(exp => {
                const el = document.createElement('div');
                // Icono simple
                const icon = exp.paid ? 'fa-check' : 'fa-tag';
                const color = exp.paid ? 'bg-emerald-50 border-emerald-200 text-emerald-700' : 'bg-white border-slate-100 text-slate-700';
                
                // Permitir borrar si es mío O si soy admin
                const canDelete = (currentUser.email === exp.userEmail) || (userRole === 'admin');
                const deleteBtn = canDelete ? `<button onclick="window.deleteExp('${exp.id}')" class="text-slate-300 hover:text-red-500 p-2"><i class="fas fa-trash"></i></button>` : '';

                el.className = `flex justify-between items-center p-4 rounded-2xl border shadow-sm ${color}`;
                el.innerHTML = `
                    <div class="flex items-center gap-3 flex-grow cursor-pointer" onclick="window.toggleExp('${exp.id}', ${exp.paid})">
                        <i class="fas ${icon} ${exp.paid ? 'text-emerald-500' : 'text-slate-300'}"></i>
                        <div>
                            <p class="font-bold text-sm leading-none ${exp.paid ? 'line-through opacity-50' : ''}">${exp.name}</p>
                            <p class="text-xs font-mono opacity-70">${formatMoney(exp.amount)}</p>
                        </div>
                    </div>
                    ${deleteBtn}
                `;
                list.appendChild(el);
            });
        }

        // --- ACCIONES WINDOW ---
        window.showMyView = () => { viewFilterEmail = currentUser.email; renderUI(); };

        window.addExpense = async () => {
            const nameEl = document.getElementById('inputName');
            const amountEl = document.getElementById('inputAmount');
            const btn = document.getElementById('btnAdd');
            
            const name = nameEl.value.trim();
            const amount = parseInt(amountEl.value);

            // IMPORTANTE: El gasto se asigna al usuario que se está VIENDO actualmente (para que admin pueda asignar gastos a otros)
            // O, por seguridad simple, siempre asignamos al usuario logueado. 
            // En este caso, usaremos el usuario logueado EXCEPTO si el admin quiere asignar.
            // Para simplificar, asignaremos al usuario que está logueado actualmente.
            // Si el admin está auditando, quizás quiera agregar un gasto a ESA persona.
            // Hagámoslo flexible:
            const targetEmail = (userRole === 'admin' && viewFilterEmail) ? viewFilterEmail : currentUser.email;
            
            if (!name || isNaN(amount)) return showToast("Datos inválidos");

            btn.disabled = true; 
            
            try {
                await addDoc(collection(db, "gastos"), {
                    userEmail: targetEmail, // Asociamos por correo
                    name: name,
                    amount: amount,
                    paid: false,
                    date: Date.now()
                });
                nameEl.value = ''; amountEl.value = '';
                showToast("Guardado");
            } catch(e) { showToast("Error"); }
            btn.disabled = false;
        };

        window.toggleExp = async (id, status) => {
            try { await updateDoc(doc(db, "gastos", id), { paid: !status }); } catch(e){}
        };

        window.deleteExp = async (id) => {
            if(confirm("¿Borrar?")) try { await deleteDoc(doc(db, "gastos", id)); } catch(e){}
        };
        
        window.resetMonth = async () => {
            if(!confirm("¿NUEVO MES? Se desmarcarán todos los pagos.")) return;
            // Batch update (simple)
            // Nota: En prod usar Cloud Functions para esto, pero aquí en cliente:
            const q = query(collection(db, "gastos"));
            // ... lógica simplificada para demo (iterar)
             // Firestore SDK cliente no tiene "updateAll", hay que iterar.
             // Para evitar descargas masivas, solo avisamos. 
             alert("Para reiniciar mes en versión Google, elimina o edita manualmente. (Función masiva deshabilitada por seguridad en demo)");
        };

        function formatMoney(val) { return new Intl.NumberFormat('es-CL', {style:'currency', currency:'CLP', maximumFractionDigits:0}).format(val); }
        function showToast(msg) {
            const t = document.getElementById('toast'); t.textContent = msg;
            t.classList.remove('opacity-0', '-translate-y-4');
            setTimeout(() => t.classList.add('opacity-0', '-translate-y-4'), 3000);
        }
    </script>
</body>
</html>
```

### ⚠️ Instrucciones Críticas de Configuración ⚠️

1.  **Firebase Config:** Pega tus llaves (`apiKey`, `authDomain`, etc.) donde dice `TU_API_KEY`.
2.  **Family Config (¡Nuevo!):** Busca la sección `const FAMILY_CONFIG`.
    * **Debes escribir los correos Gmail reales**.
    * Ejemplo:
        ```javascript
        const FAMILY_CONFIG = {
            'papa.perez@gmail.com': { role: 'admin', label: 'Papá' },
            'mama.perez@gmail.com': { role: 'user', label: 'Mamá' }
        };
