<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finanzas Casa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden-view { display: none !important; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        /* Barras de Presupuesto */
        .progress-bar { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .bg-p-green { background-color: #10b981; }
        .bg-p-yellow { background-color: #f59e0b; }
        .bg-p-red { background-color: #ef4444; }

        /* Colores Sync */
        .sync-red { background: white; border-left: 6px solid #ef4444; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .sync-yellow { background: #fffbeb; border-left: 6px solid #f59e0b; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .sync-green { background: #f0fdf4; border-left: 6px solid #22c55e; opacity: 0.8; }
        .badge-green { background: #dcfce7; color: #166534; }

        /* Tarjeta Personal */
        .card-personal { cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .card-personal:active { transform: scale(0.97); }
        .card-personal-pending { background: white; border-color: #e2e8f0; }
        .card-personal-done { background: #dcfce7; border-color: #22c55e; color: #14532d; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800">

    <!-- LOGIN -->
    <div id="view-login" class="flex flex-col items-center justify-center min-h-screen p-6 fade-in">
        <div class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-sm text-center border border-slate-100">
            <div class="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-home text-4xl text-indigo-600"></i>
            </div>
            <h1 class="text-3xl font-extrabold text-slate-800 mb-2">Finanzas Casa</h1>
            <p class="text-slate-400 text-sm mb-8">Control y Transparencia</p>
            <button onclick="loginWithGoogle()" class="w-full bg-white border border-slate-300 text-slate-700 font-bold py-4 rounded-xl shadow-sm hover:bg-slate-50 flex items-center justify-center gap-3 transition active:scale-95 group">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 group-hover:scale-110 transition">
                Entrar con Google
            </button>
            <p id="login-error" class="text-red-500 text-xs mt-4 font-bold hidden"></p>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="view-app" class="hidden-view pb-32 fade-in">
        
        <!-- Navbar -->
        <nav class="bg-white sticky top-0 z-30 px-5 py-4 shadow-sm border-b border-slate-100 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img id="userPhoto" src="" class="w-10 h-10 rounded-full border-2 border-slate-200">
                <div class="leading-tight">
                    <p class="text-[10px] uppercase font-bold text-slate-400">Hola</p>
                    <p id="userName" class="font-bold text-slate-800 text-sm">Usuario</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="exportTextReport()" class="w-9 h-9 rounded-full bg-slate-800 text-white hover:bg-black flex items-center justify-center transition shadow-lg" title="Descargar Reporte">
                    <i class="fas fa-file-alt text-xs"></i>
                </button>
                <div class="bg-slate-100 rounded-lg px-2 py-1">
                    <input type="month" id="monthSelector" class="bg-transparent text-xs font-bold text-slate-600 outline-none cursor-pointer" onchange="changeMonth()">
                </div>
            </div>
        </nav>

        <main class="p-5 max-w-6xl mx-auto space-y-6">

            <!-- 1. METAS (PRESUPUESTO) -->
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 relative overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest"><i class="fas fa-bullseye mr-1"></i> Metas Mensuales</h3>
                    <button id="btnAddBudget" onclick="addBudget()" class="text-[10px] bg-slate-100 px-2 py-1 rounded text-blue-600 font-bold hover:bg-blue-50">+ Meta</button>
                </div>
                <div id="budgetsContainer" class="space-y-4">
                    <div class="text-center py-2 text-xs text-slate-300">Cargando...</div>
                </div>
            </div>

            <!-- 2. FORMULARIO -->
            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 relative z-10">
                <div class="flex justify-between items-center mb-3">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Nuevo Gasto</p>
                    <span id="loadingDefaults" class="text-[10px] text-blue-500 animate-pulse hidden">Actualizando...</span>
                </div>
                
                <div id="smartButtons" class="flex gap-2 overflow-x-auto hide-scroll mb-4 pb-1"></div>

                <div class="flex flex-col md:flex-row gap-3">
                    <div class="flex-grow flex gap-3">
                        <input type="text" id="inputName" placeholder="Concepto" class="w-full p-3 bg-slate-50 rounded-xl font-bold text-sm outline-none focus:ring-2 focus:ring-indigo-100 transition">
                        <input type="number" id="inputAmount" placeholder="$ Total" class="w-1/3 p-3 bg-slate-50 rounded-xl font-bold text-center text-sm outline-none focus:ring-2 focus:ring-indigo-100 transition">
                    </div>
                    
                    <div class="flex gap-2">
                        <div class="bg-slate-100 p-1 rounded-xl flex">
                            <!-- Solo Vicho y Carlos pueden marcar "Casa" -->
                            <button onclick="setType('house')" id="btnTypeHouse" class="px-4 py-2 rounded-lg text-xs font-bold bg-white shadow-sm text-indigo-600 transition flex items-center gap-1"><i class="fas fa-home"></i> Casa</button>
                            <button onclick="setType('personal')" id="btnTypePersonal" class="px-4 py-2 rounded-lg text-xs font-bold text-slate-400 hover:text-slate-600 transition flex items-center gap-1"><i class="fas fa-user"></i> MÃ­o</button>
                        </div>
                        <button onclick="saveExpense()" class="bg-slate-900 text-white px-6 py-2 rounded-xl font-bold text-sm hover:bg-black transition shadow-lg active:scale-95">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <input type="hidden" id="currentType" value="house">
                <input type="hidden" id="currentCategory" value="General">
            </div>

            <!-- 3. VISTA DIVIDIDA -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- IZQUIERDA: ESTADO DE CUENTAS (Visible para TODOS) -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-2">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-slate-400"></span> Estado del Hogar
                        </h3>
                        <span class="text-xs font-mono font-bold text-slate-400" id="totalHouse">$0</span>
                    </div>
                    <div id="houseList" class="space-y-3"></div>
                </div>

                <!-- DERECHA: MIS PAGOS (Editable solo por mÃ­) -->
                <div class="space-y-4">
                    <div class="flex items-center justify-between px-2">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Mis Pagos
                        </h3>
                        <span class="text-xs font-mono font-bold text-emerald-600" id="totalPersonal">$0</span>
                    </div>
                    <div id="personalList" class="space-y-3"></div>
                </div>

            </div>

        </main>
    </div>

    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl text-xs font-bold opacity-0 transition-all pointer-events-none z-50 -translate-y-4 flex items-center gap-2">
        <span id="toastMsg">Mensaje</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, updateDoc, deleteDoc, setDoc, getDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ==========================================
        // 1. CREDENCIALES
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyALsMoeqqLpQge9hMocUHSjmqnpJXNJ9p4",
            authDomain: "control-mensual-ae833.firebaseapp.com",
            projectId: "control-mensual-ae833",
            storageBucket: "control-mensual-ae833.firebasestorage.app",
            messagingSenderId: "909368343478",
            appId: "1:909368343478:web:0733b7a0a57cec5893df17"
        };

        // ==========================================
        // 2. CONFIGURACIÃ“N FAMILIA
        // ==========================================
        const SPLIT_USERS = ['vicente8sanchez@gmail.com', 'carlosinvictus50@gmail.com']; 

        const FAMILY_CONFIG = {
            'vicente8sanchez@gmail.com': { name: 'Vicente', role: 'admin' },
            'carlosinvictus50@gmail.com':  { name: 'Carlos',  role: 'partner' },
            'anabellc.nc@gmail.com':  { name: 'Anabel',  role: 'user' },
            'juanpapino10@gmail.com':      { name: 'JP',      role: 'user' }
        };

        const BASE_SERVICES = [
            { name: 'Arriendo', amount: 350000, icon: 'fa-home', category: 'Hogar' },
            { name: 'Luz', amount: 45000, icon: 'fa-lightbulb', category: 'Servicios' },
            { name: 'Agua', amount: 25000, icon: 'fa-faucet', category: 'Servicios' },
            { name: 'Gas', amount: 60000, icon: 'fa-fire', category: 'Servicios' },
            { name: 'Super', amount: 150000, icon: 'fa-shopping-cart', category: 'Supermercado' },
            { name: 'Internet', amount: 30000, icon: 'fa-wifi', category: 'Servicios' },
            { name: 'G. ComÃºn', amount: 90000, icon: 'fa-building', category: 'Hogar' },
            { name: 'Gatos', amount: 20000, icon: 'fa-cat', category: 'Mascotas' }
        ];

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let selectedMonth = new Date().toISOString().slice(0, 7);
        let allData = [];
        let priceMemory = {};
        let budgets = {};

        // AUTH
        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, provider); } catch(e){ document.getElementById('login-error').textContent = e.message; document.getElementById('login-error').classList.remove('hidden'); } };
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (FAMILY_CONFIG[user.email]) {
                    currentUser = { ...user, ...FAMILY_CONFIG[user.email] };
                    initUI();
                } else {
                    alert("ðŸš« Acceso Denegado: Tu correo no estÃ¡ en la lista de familia.");
                    signOut(auth);
                }
            } else {
                document.getElementById('view-app').classList.add('hidden-view');
                document.getElementById('view-login').classList.remove('hidden-view');
            }
        });

        async function initUI() {
            document.getElementById('view-login').classList.add('hidden-view');
            document.getElementById('view-app').classList.remove('hidden-view');
            document.getElementById('userPhoto').src = currentUser.photoURL;
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('monthSelector').value = selectedMonth;

            if (currentUser.role === 'user') {
                document.getElementById('btnTypeHouse').classList.add('hidden');
                document.getElementById('btnAddBudget').classList.add('hidden');
                window.setType('personal');
            } else {
                document.getElementById('btnTypeHouse').classList.remove('hidden');
                document.getElementById('btnAddBudget').classList.remove('hidden');
                window.setType('house');
            }

            await loadPriceMemory();
            await loadBudgets();
            listenData();
        }

        async function loadBudgets() {
            try {
                const docRef = doc(db, "config", "presupuestos");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) budgets = docSnap.data();
                else budgets = { 'Supermercado': 200000, 'Servicios': 150000 }; 
            } catch(e) {}
        }

        window.addBudget = async () => {
            if (currentUser.role === 'user') return; 
            const cat = prompt("CategorÃ­a (ej: Ocio):");
            if(!cat) return;
            const limit = prompt("LÃ­mite ($):");
            if(!limit) return;
            budgets[cat] = parseInt(limit);
            await setDoc(doc(db, "config", "presupuestos"), budgets);
            renderBudgets();
        };

        function renderBudgets() {
            const container = document.getElementById('budgetsContainer');
            container.innerHTML = '';
            const spending = {};
            allData.forEach(item => {
                if (item.isParent || (item.type === 'personal' && item.userId === currentUser.email)) {
                    const cat = item.category || 'General';
                    spending[cat] = (spending[cat] || 0) + item.amount;
                }
            });

            for (const [cat, limit] of Object.entries(budgets)) {
                const current = spending[cat] || 0;
                const percent = Math.min((current / limit) * 100, 100);
                let barColor = 'bg-p-green';
                if (percent > 75) barColor = 'bg-p-yellow';
                if (percent >= 100) barColor = 'bg-p-red';

                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="flex justify-between text-xs mb-1">
                        <span class="font-bold text-slate-600">${cat}</span>
                        <span class="font-mono text-slate-400">${formatMoney(current)} / ${formatMoney(limit)}</span>
                    </div>
                    <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                        <div class="h-full ${barColor} progress-bar" style="width: ${percent}%"></div>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        async function loadPriceMemory() {
            try {
                const docRef = doc(db, "config", "precios_aprendidos");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) priceMemory = docSnap.data();
                else BASE_SERVICES.forEach(s => priceMemory[s.name] = s.amount);
                renderSmartButtons();
            } catch(e) {}
        }

        async function learnPrice(name, amount) {
            priceMemory[name] = amount;
            try { await setDoc(doc(db, "config", "precios_aprendidos"), priceMemory); renderSmartButtons(); } catch(e){}
        }

        function renderSmartButtons() {
            const container = document.getElementById('smartButtons');
            container.innerHTML = '';
            BASE_SERVICES.forEach(s => {
                const amount = priceMemory[s.name] || s.amount;
                const formatted = amount >= 1000 ? `${Math.round(amount/1000)}k` : amount;
                const btn = document.createElement('button');
                btn.className = "flex-shrink-0 bg-white border border-slate-200 text-slate-600 px-3 py-2 rounded-xl text-xs font-bold shadow-sm hover:border-indigo-300 hover:text-indigo-600 transition active:scale-95 flex flex-col items-center min-w-[70px]";
                btn.onclick = () => prefill(s.name, amount, true, s.category);
                btn.innerHTML = `<i class="fas ${s.icon} text-lg mb-1 opacity-50"></i><span>${s.name}</span><span class="text-[9px] font-mono text-slate-400 mt-0.5">$${formatted}</span>`;
                container.appendChild(btn);
            });
        }

        window.changeMonth = () => { selectedMonth = document.getElementById('monthSelector').value; listenData(); };

        function listenData() {
            const q = query(collection(db, "gastos"), where("month", "==", selectedMonth));
            onSnapshot(q, (snapshot) => {
                allData = [];
                snapshot.forEach(doc => allData.push({ id: doc.id, ...doc.data() }));
                renderLists();
                renderBudgets();
            });
        }

        function renderLists() {
            const houseList = document.getElementById('houseList');
            const personalList = document.getElementById('personalList');
            houseList.innerHTML = '';
            personalList.innerHTML = '';

            let totalH = 0;
            let totalP = 0;

            const myExpenses = allData.filter(e => e.type === 'house' || e.userId === currentUser.email);
            myExpenses.sort((a, b) => b.amount - a.amount);

            if(myExpenses.length === 0) {
                houseList.innerHTML = '<div class="text-center py-6 text-slate-300 text-xs italic">Limpio</div>';
            }

            myExpenses.forEach(item => {
                const isHouse = item.type === 'house';
                const isMine = item.userId === currentUser.email;

                if (isHouse && item.isParent) {
                    totalH += item.amount;
                    const parts = allData.filter(sub => sub.parentId === item.id);
                    const paidCount = parts.filter(sub => sub.paid).length;
                    
                    let statusClass = 'sync-red';
                    let badgeText = 'IMPAGO';
                    let badgeClass = 'badge-red';

                    if (paidCount > 0 && paidCount < parts.length) {
                        statusClass = 'sync-yellow'; badgeText = 'PARCIAL'; badgeClass = 'badge-yellow';
                    } else if (paidCount === parts.length && parts.length > 0) {
                        statusClass = 'sync-green'; badgeText = 'LISTO'; badgeClass = 'badge-green';
                    }

                    const div = document.createElement('div');
                    div.className = `p-4 rounded-2xl border shadow-sm transition ${statusClass} relative`;
                    
                    const canManage = (currentUser.role === 'admin' || currentUser.role === 'partner');
                    const deleteBtn = canManage ? `<button onclick="deleteGlobal('${item.id}')" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 w-6 h-6 flex items-center justify-center rounded-full transition"><i class="fas fa-trash-alt text-xs"></i></button>` : '';

                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-slate-700 leading-tight">${item.name}</h4>
                                <p class="text-xs font-mono font-bold text-slate-400 mt-1">${formatMoney(item.amount)}</p>
                            </div>
                            <span class="px-2 py-1 rounded text-[9px] font-bold uppercase ${badgeClass} mr-6">${badgeText}</span>
                        </div>
                        ${deleteBtn}
                    `;
                    houseList.appendChild(div);
                }

                if ((!isHouse && isMine) || (isHouse && !item.isParent && isMine)) {
                    totalP += item.amount;
                    const div = document.createElement('div');
                    const paidClass = item.paid ? 'card-personal-done' : 'card-personal-pending';
                    const icon = isHouse ? 'fa-home' : 'fa-user';
                    
                    div.className = `card-personal p-3 rounded-2xl border flex justify-between items-center shadow-sm ${paidClass}`;
                    div.onclick = () => togglePaid(item.id, item.paid);

                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm text-slate-400">
                                <i class="fas ${item.paid ? 'fa-check text-green-500' : icon}"></i>
                            </div>
                            <div>
                                <p class="font-bold text-sm leading-tight">${item.name}</p>
                                <p class="text-xs font-mono font-bold opacity-70">${formatMoney(item.amount)}</p>
                            </div>
                        </div>
                    `;
                    personalList.appendChild(div);
                }
            });

            document.getElementById('totalHouse').textContent = formatMoney(totalH);
            document.getElementById('totalPersonal').textContent = formatMoney(totalP);
        }

        window.prefill = (name, amount, isHouse, category) => {
            if (isHouse && currentUser.role === 'user') return alert("Solo Admins pueden agregar gastos de casa.");
            document.getElementById('inputName').value = name;
            document.getElementById('inputAmount').value = amount;
            document.getElementById('currentCategory').value = category || 'General';
            window.setType(isHouse ? 'house' : 'personal');
            if(!amount) document.getElementById('inputAmount').focus();
        };

        window.setType = (type) => {
            document.getElementById('currentType').value = type;
            const btnH = document.getElementById('btnTypeHouse');
            const btnP = document.getElementById('btnTypePersonal');
            if(type === 'house') {
                btnH.className = "px-4 py-2 rounded-lg text-xs font-bold bg-white shadow-sm text-indigo-600 transition flex items-center gap-1";
                btnP.className = "px-4 py-2 rounded-lg text-xs font-bold text-slate-400 hover:text-slate-600 transition flex items-center gap-1";
            } else {
                btnP.className = "px-4 py-2 rounded-lg text-xs font-bold bg-white shadow-sm text-emerald-600 transition flex items-center gap-1";
                btnH.className = "px-4 py-2 rounded-lg text-xs font-bold text-slate-400 hover:text-slate-600 transition flex items-center gap-1";
            }
        };

        window.saveExpense = async () => {
            const name = document.getElementById('inputName').value;
            const amount = parseInt(document.getElementById('inputAmount').value);
            const type = document.getElementById('currentType').value;
            const category = document.getElementById('currentCategory').value;

            if(!name || isNaN(amount)) return showToast("Falta info");

            try {
                const batch = writeBatch(db);
                
                if (type === 'house' && SPLIT_USERS.includes(currentUser.email)) {
                    const parentRef = doc(collection(db, "gastos"));
                    batch.set(parentRef, {
                        name: name, amount: amount, type: 'house', isParent: true, category: category,
                        userId: 'HOUSE', month: selectedMonth, date: Date.now()
                    });
                    const half = Math.ceil(amount / 2);
                    SPLIT_USERS.forEach(email => {
                        const childRef = doc(collection(db, "gastos"));
                        batch.set(childRef, {
                            name: name, amount: half, type: 'house', isParent: false, category: category,
                            parentId: parentRef.id, userId: email, month: selectedMonth, paid: false, date: Date.now()
                        });
                    });
                    await learnPrice(name, amount);
                } else {
                    await addDoc(collection(db, "gastos"), {
                        name: name, amount: amount, type: 'personal', category: category,
                        userId: currentUser.email, month: selectedMonth, paid: false, date: Date.now()
                    });
                }

                await batch.commit();
                document.getElementById('inputName').value = '';
                document.getElementById('inputAmount').value = '';
                showToast("Guardado");
            } catch(e) { console.error(e); }
        };

        window.exportTextReport = () => {
            if (allData.length === 0) return showToast("Nada");
            let text = `REPORTE FINANCIERO - ${selectedMonth}\n===================================\n\n`;
            const totalH = allData.filter(e => e.isParent).reduce((s, e) => s + e.amount, 0);
            const myTotal = allData.filter(e => (!e.isParent && e.userId === currentUser.email)).reduce((s, e) => s + e.amount, 0);
            text += `GASTOS HOGAR: ${formatMoney(totalH)}\nMI BOLSILLO:  ${formatMoney(myTotal)}\n\nDETALLE:\n`;
            allData.forEach(e => {
                if (e.isParent || (e.type === 'personal' && e.userId === currentUser.email)) {
                    let statusStr = "Pendiente";
                    if(e.isParent) {
                        const parts = allData.filter(sub => sub.parentId === e.id);
                        const paidCount = parts.filter(sub => sub.paid).length;
                        statusStr = (paidCount === parts.length) ? "PAGADO TOTAL" : "PARCIAL";
                    } else { statusStr = e.paid ? "PAGADO" : "PENDIENTE"; }
                    text += `${e.name.padEnd(20)} | ${formatMoney(e.amount).padEnd(10)} | ${statusStr}\n`;
                }
            });
            const blob = new Blob([text], { type: 'text/plain' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Reporte_${selectedMonth}.txt`;
            link.click();
        };

        window.togglePaid = async (id, status) => { await updateDoc(doc(db, "gastos", id), { paid: !status }); };
        window.deleteGlobal = async (parentId) => { if(confirm("Â¿Borrar?")) { const b = writeBatch(db); b.delete(doc(db, "gastos", parentId)); allData.filter(d=>d.parentId===parentId).forEach(c=>b.delete(doc(db,"gastos",c.id))); await b.commit(); }};
        function formatMoney(val) { return new Intl.NumberFormat('es-CL', {style:'currency', currency:'CLP', maximumFractionDigits:0}).format(val); }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.remove('-translate-y-4', 'opacity-0'); setTimeout(() => t.classList.add('-translate-y-4', 'opacity-0'), 3000); }
    </script>
</body>
</html>
